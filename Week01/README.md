# 第一课 架构实践 - 微服务（概览与治理）

[toc]

**发现痛点！**（也就是科研中的 ”发现问题“ ，不要为使用工具而使用工具）

- 2020.11.18 微服务概览 + 微服务设计

- 2020.11.21 gRPC ...

## 微服务概览 *<3-11>*

微服务为 `SOA`（面向服务）的一种实践 *<4>*

- 代码量少
- 单一职责（少出现 `utils` 之类的包）
- 尽早定义 API （原型）
- 可移植性 > 开发效率

定义与特点：*<5>*

- 原子服务
- 独立进程
- 隔离部署
- 去中心化服务治理

### 组件服务化 *<7>*

- kit：基础库（SpringCloud）
- service：业务代码 + kit + dep ，可独立部署
- rpc + message queue：轻量级通讯 (grpc/http, kafka)

多个微服务组合（compose）成了一个完整的用户场景（usecase）

### 按业务组织服务 *<8>*

[康威定律](https://zh.wikipedia.org/wiki/%E5%BA%B7%E5%A8%81%E5%AE%9A%E5%BE%8B)：即系统设计本质上反映了企业的组织机构。系统各个模块间的接口也反映了企业各个部门之间的信息流动和合作方式

- 开发人员职责：开发 + 测试 + 部署 + 监控

- 测试、运维人员：提供相应的平台

### 去中心化  *<9>*

- 数据

每个服务独占一个 DB

```txt
         +--------+
     +---+        +--------+
     |   +------+-+        |
     |          |          |
+----+---+  +---+----+ +---+----+
| SVC1   |  |  SVC2  | |  SVC3  |
+----+---+  +---+----+ +----+---+
     |          |           |
  +--+-+      +-+--+      +-+--+
  | DB1|      | DB2|      |DB3 |
  +----+      +----+      +----+
```

- 治理

出现流量热点（e.g. 账号服务）

- 技术

### 基础设施自动化  *<10>*

- CICD：Gitlab + Gitlab Hooks + K8S

- Testing：测试环境（多租户）、单元测试、API自动化测试
- 在线运行时：K8S，Prometheus、ELK、Control Panel

### 可用性 & 兼容性设计 *<11>*

- **Design For Failure**
- 粗粒度进程间通信（batch）
- 隔离
- 超时控制
- 负载保护 
- 限流
- 降级
- 重试
- 负载均衡

## 微服务设计 *<13-19>*

主要内容：

- 架构的演进 *<13-16>*
- 服务划分 *<17-18>*



❌ 面向资源的 API

✔️ 面向用户场景的 API 



**前端 --- [ CDN/负载均衡 ] --- [ API Gateway (Envoy) --- BFF（Backend for Frontend） --- Microservice ]**

CQRS [18]：命令端（w） + 查询端（r）



安全：

1. 用户 - `[token/Cookie]`-> Gateway - `[内网token]` -> BFF - `[userID]` -> Microservice
2. 身份认证（证书） + 授权（RBAC）

## gRPC & 服务发现 *<21-28>*

服务发现为了解决的问题：容器场景下服务的 IP 动态改变

gRPC: 不局限于语言；使用HTTP2（单TCP复用）；标准化（pb）

### HealthCheck *<23>*

```txt
                  +----------------+
                  |                |
        +-------->+   discovery    +------+
        |         |                |      |
   register       +----------------+    poll
        |                                 |
        |                                 v
+-------+---------+             +---------+--------+
|                 |     call    |                  |
|    provider     +<------------+     consumer     |
|                 |             |                  |
+-------+---------+             +---------+--------+
        ^                                 |
        |                                 |
        |                                 |
        |              health check       |
        +---------------------------------+
```

- 链路连通性/流量监测
- 平滑发布

```txt
+---------------+                      +--------------+
|               | +----------+ 2. tell |              |
|   provider    | |  sidecar |         |   discovery  |
|               <-+----------+-------->+              |
+---------------+                      +--------------+
               1. health check
               if provider has started
```

- 平滑下线

```txt
                   +----------------+
                   |                |
          +--------+    discovery   +---------+
          |        |                |         |
  1.1 kill/kill -9 +--+-------------+         |  3 provider is killed
          |           ^  1.2 ok               |
          |  +--------+                       |
          |  |                                |
          v  |          2.1 health check      v
+---------+--+----+                  +--------+-------+
|                 +<-----------------+                |
|   provider      |                  |    consumer    |
|                 +----------------->+                |
+-----------------+                  +----------------+
                         2.2 failed
```

### 服务发现类型 *<24-26>*

- 客户端发现 (进化：SM: LB+C)

```txt
               +--------------+
               |  consumer    |
      +--------+              |
      |        +------+-------+
      |               |
      | 2. directly   | 1. request for
      | connect       |    provider
+-----+----+          v
|   LB     |   +------+--------+
|          |   |    discovery  |
+-----+----+   |               |
      |        +-------+--+----+
      |                |  ^
      |                v  |
      |           +----+--+---+
      +---------->+  provider |
                  |           |
                  +-----------+
```

- 服务端发现 (k8s Ingress)

```txt
     +--------------+
     |  consumer    |
     |              |
     +-----+--------+
           |
           v
      +----+-------+   not directly
      |  LB        |   connect
      |            +----+
      +--+---------+    |
         |              v
+------------+   +------+------+
|   discovery|   | provider    |
|            |   |             |
+------------+   +-------------+
```

### CAP

**Euerka**：AP , Bilibili 自己实现，[discovery](https://github.com/bilibili/discovery) ？ *<28>* **设计**

Nacos

## 多集群 & 多租户 *<30-36>*

热点集群，gRPC 连接数过多，healthcheck 对集群产生很大负载： 从全集群中选取一个子集: GoogleSRE *<32>* 